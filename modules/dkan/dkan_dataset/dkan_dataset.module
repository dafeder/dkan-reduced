<?php

/**
 * @file
 * Custom elements for datasets.
 */

include_once 'dkan_dataset.features.inc';
include_once 'dkan_dataset.theme.inc';
include_once 'dkan_dataset.forms.inc';

/**
 * Implements hook_node_view().
 */
function dkan_dataset_node_view($node, $view_mode, $langcode) {
  if ($view_mode == 'full' && $node->type == 'dataset') {

    $node->content['resources'] = array(
      '#type' => 'item',
      '#theme' => 'dkan_dataset_resource_view',
      '#node' => $node,
      '#enabled' => TRUE,
      '#title' => t('Data and Resources'),
      '#label_display' => 'above',
      '#prefix' => '<div id="data-and-resources">',
      '#suffix' => '</div>',
      '#view_mode' => $view_mode,
    );
    $node->content['release_date'] = array(
      '#theme' => 'dkan_dataset_release_date_view',
      '#node' => $node,
      '#enabled' => TRUE,
      '#title' => t('Release Date'),
      '#label_display' => 'above',
      '#items' => array(),
      '#field_name' => '',
      '#field_type' => '',
      '#bundle' => $node->type,
      '#view_mode' => $view_mode,
    );
    $node->content['modified_date'] = array(
      '#theme' => 'dkan_dataset_modified_date_view',
      '#node' => $node,
      '#enabled' => TRUE,
      '#title' => t('Modified Date'),
      '#label_display' => 'above',
      '#items' => array(),
      '#field_name' => '',
      '#field_type' => '',
      '#bundle' => $node->type,
      '#view_mode' => $view_mode,
    );
    $node->content['identifier'] = array(
      '#theme' => 'dkan_dataset_identifier_view',
      '#node' => $node,
      '#enabled' => TRUE,
      '#title' => t('Identifier'),
      '#label_display' => 'above',
      '#items' => array(),
      '#field_name' => '',
      '#field_type' => '',
      '#bundle' => $node->type,
      '#view_mode' => $view_mode,
    );
  }
  elseif ($view_mode == 'teaser' && ($node->type == 'dataset' || $node->type == 'resource')) {
    if (isset($node->content['links']['node']['#links']['node-readmore'])) {
      unset($node->content['links']['node']['#links']['node-readmore']);
    }
    $node->content['body']['#weight'] = '-10';
    $node->content['resources'] = array(
      '#type' => 'item',
      '#theme' => 'dkan_dataset_resource_teaser_view',
      '#node' => $node,
      '#enabled' => TRUE,
      '#title' => '',
      '#label_display' => 'above',
      '#prefix' => '<div class="data-and-resources">',
      '#suffix' => '</div>',
      '#weight' => '20',
    );
  }
}

/**
 * Implements hook_field_extra_fields().
 */
function dkan_dataset_field_extra_fields() {
  $extra['node']['dataset'] = array(
    'form' => array(
      'resources' => array(
        'label' => t('Data and Resources'),
        'description' => t('Shows book children of dataset'),
        'weight' => 0,
      ),
      'release_date' => array(
        'label' => t('Release Date'),
        'description' => t('Node published date available as a field'),
        'weight' => 0,
      ),
      'modified_date' => array(
        'label' => t('Modified Date'),
        'description' => t('Node changed date available as a field'),
        'weight' => 0,
      ),
      'identifier' => array(
        'label' => t('Identifier'),
        'description' => t('Unique identifier for dataset'),
        'weight' => 0,
      )
    ),
    'display' => array(
      'resources' => array(
        'label' => t('Data and Resources'),
        'description' => t('Shows book children of dataset'),
        'weight' => 0,
      ),
      'release_date' => array(
        'label' => t('Release Date'),
        'description' => t('Node published date available as a field'),
        'weight' => 0,
      ),
      'modified_date' => array(
        'label' => t('Modified Date'),
        'description' => t('Node changed date available as a field'),
        'weight' => 0,
      ),
      'identifier' => array(
        'label' => t('Identifier'),
        'description' => t('Unique identifier for dataset'),
        'weight' => 0,
      )
    ),
  );

  return $extra;
}

/**
 * Helper to get Resource nodes linked to a Dataset.
 */
function dkan_dataset_get_resource_nodes($nid) {
  $nodes = array();
  $nids = array();
  $query = new EntityFieldQuery;

  $results = $query
    ->entityCondition('entity_type', 'node')
    ->fieldCondition('field_dataset_ref', 'target_id', $nid, '=')
    ->execute();
  if ($results) {
    foreach ($results as $node) {
      foreach ($node as $nid => $obj) {
        $nids[] = $nid;
      }
    }
  }
  $nodes = isset($nids) ? node_load_multiple($nids) : array();
  return $nodes;
}

/**
 * Helper to get title from nid.
 */
function dkan_dataset_get_title($nid) {
  $result = db_select('node', 'n')
    ->fields('n', array('title'))
    ->condition('nid', $nid,'=')
    ->execute()
    ->fetchAssoc();
  if (isset($result['title'])) {
    return $result['title'];
  }
  else {
    return FALSE;
  }
}

/**
 * Returns trimmed text using views_trim_text().
 */
function dkan_dataset_text_trim($title, $number = 25) {
  $alter = array(
    'max_length' => $number,
    'ellipsis' => TRUE,
    'word_boundary' => TRUE,
    'trim' => TRUE,
  );
  return views_trim_text($alter, $title);
}

/**
 * Implements hook_libraries_info().
 */
function dkan_dataset_libraries_info() {
  $libraries['slugify'] = array(
    'name' => 'Slugify',
    'vendor url' => 'https://github.com/pmcelhaney/jQuery-Slugify-Plugin',
    'download url' => 'https://github.com/pmcelhaney/jQuery-Slugify-Plugin/archive/master.zip',
    'files' => array('js' => array('jquery.slugify')),
    'version' => 'master',
  );

  return $libraries;
}
